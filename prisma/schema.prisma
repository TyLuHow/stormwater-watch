generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  role      Role     @default(PARTNER)
  createdAt DateTime @default(now())

  subscriptions Subscription[]
}

enum Role {
  ADMIN
  PARTNER
}

model Facility {
  id             String    @id @default(cuid())
  name           String
  permitId       String    @unique
  naics          String?
  lat            Decimal   @db.Decimal(9, 6)
  lon            Decimal   @db.Decimal(9, 6)
  county         String?
  watershedHuc12 String?
  ms4            String?
  receivingWater String?
  isInDAC        Boolean   @default(false)
  enrichedAt     DateTime?
  createdAt      DateTime  @default(now())
  lastSeenAt     DateTime  @default(now())

  // Link to eSMR facility data
  esmrFacilityId Int?
  esmrFacility   ESMRFacility? @relation(fields: [esmrFacilityId], references: [facilityPlaceId])

  samples          Sample[]
  violationEvents  ViolationEvent[]
  violationSamples ViolationSample[]
  alerts           Alert[]

  @@index([county])
  @@index([watershedHuc12])
  @@index([ms4])
  @@index([isInDAC])
  @@index([esmrFacilityId])
}

model Sample {
  id              String   @id @default(cuid())
  facilityId      String
  facility        Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  sampleDate      DateTime @db.Date
  pollutant       String
  value           Decimal  @db.Decimal(12, 4)
  unit            String
  benchmark       Decimal  @db.Decimal(12, 4)
  benchmarkUnit   String
  exceedanceRatio Decimal? @db.Decimal(8, 2)
  reportingYear   String
  source          String
  sourceDocUrl    String?  @db.Text
  createdAt       DateTime @default(now())

  @@index([facilityId, pollutant, sampleDate])
  @@index([reportingYear])
  @@index([exceedanceRatio])
  @@index([facilityId])
  @@index([pollutant])
  @@index([sampleDate])
}

model ViolationEvent {
  id            String            @id @default(cuid())
  facilityId    String
  facility      Facility          @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  pollutantKey  String
  pollutant     ConfigPollutant   @relation(fields: [pollutantKey], references: [key])
  firstDate     DateTime          @db.Date
  lastDate      DateTime          @db.Date
  count         Int
  maxRatio      Decimal           @db.Decimal(8, 2)
  maxSeverity   ViolationSeverity @default(MODERATE)
  reportingYear String
  impairedWater Boolean           @default(false)
  dismissed     Boolean           @default(false)
  notes         String?           @db.Text
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  alerts  Alert[]
  samples ViolationSample[]

  @@unique([facilityId, pollutantKey, reportingYear])
  @@index([facilityId, pollutantKey, reportingYear])
  @@index([dismissed])
  @@index([facilityId])
  @@index([pollutantKey])
  @@index([reportingYear])
  @@index([maxRatio])
  @@index([maxSeverity])
}

model ViolationSample {
  id String @id @default(cuid())

  // Link to aggregate violation event
  violationEventId String
  violationEvent   ViolationEvent @relation(fields: [violationEventId], references: [id], onDelete: Cascade)

  // Link to facility (denormalized for query efficiency)
  facilityId String
  facility   Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade)

  // Link to source eSMR sample
  esmrSampleId String
  esmrSample   ESMRSample @relation(fields: [esmrSampleId], references: [id], onDelete: Cascade)

  // Link to benchmark that was exceeded
  benchmarkId String
  benchmark   PollutantBenchmark @relation(fields: [benchmarkId], references: [id])

  // Pollutant key (denormalized for filtering)
  pollutantKey String

  // Violation details
  detectedAt      DateTime          @db.Date
  measuredValue   Decimal           @db.Decimal(18, 6)
  measuredUnit    String            @db.VarChar(50)
  benchmarkValue  Decimal           @db.Decimal(18, 6)
  benchmarkUnit   String            @db.VarChar(50)
  exceedanceRatio Decimal           @db.Decimal(8, 2)
  severity        ViolationSeverity

  // Compliance tracking
  status      ViolationStatus @default(OPEN)
  reviewedAt  DateTime?
  reviewedBy  String?
  reviewNotes String?         @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Ensure no duplicate violations for the same sample
  @@unique([esmrSampleId, benchmarkId])
  @@index([violationEventId])
  @@index([facilityId])
  @@index([esmrSampleId])
  @@index([benchmarkId])
  @@index([pollutantKey])
  @@index([detectedAt])
  @@index([status])
  @@index([severity])
  @@index([facilityId, pollutantKey, detectedAt])
  @@index([status, severity])
  @@map("violation_samples")
}

enum ViolationStatus {
  OPEN
  UNDER_REVIEW
  RESOLVED
  DISMISSED

  @@map("violation_status")
}

enum ViolationSeverity {
  LOW
  MODERATE
  HIGH
  CRITICAL

  @@map("violation_severity")
}

model Subscription {
  id                      String           @id @default(cuid())
  userId                  String
  user                    User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  name                    String
  mode                    SubscriptionMode
  params                  Json
  minRatio                Decimal          @default(1.0) @db.Decimal(4, 2)
  repeatOffenderThreshold Int              @default(2)
  impairedOnly            Boolean          @default(false)
  schedule                Schedule
  delivery                Delivery         @default(EMAIL)
  active                  Boolean          @default(true)
  lastRunAt               DateTime?
  createdAt               DateTime         @default(now())
  alerts                  Alert[]

  @@index([active, schedule])
}

enum SubscriptionMode {
  POLYGON
  BUFFER
  JURISDICTION
}

enum Schedule {
  DAILY
  WEEKLY
}

enum Delivery {
  EMAIL
  SLACK
  BOTH
}

model Alert {
  id               String          @id @default(cuid())
  subscriptionId   String
  subscription     Subscription    @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  facilityId       String
  facility         Facility        @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  violationEventId String?
  violationEvent   ViolationEvent? @relation(fields: [violationEventId], references: [id], onDelete: Cascade)
  sentAt           DateTime        @default(now())
  payload          Json

  @@index([sentAt])
  @@index([subscriptionId])
  @@index([facilityId])
  @@index([violationEventId])
}

model Provenance {
  id        String   @id @default(cuid())
  source    String
  url       String?
  fileKey   String?
  checksum  String?
  fetchedAt DateTime @default(now())
  notes     String?
}

model ConfigPollutant {
  key           String   @id
  aliases       String[]
  canonicalUnit String
  category      String?  @db.VarChar(100)
  notes         String?  @db.Text

  benchmarks      PollutantBenchmark[]
  violationEvents ViolationEvent[]

  @@index([category])
}

model PollutantBenchmark {
  id String @id @default(cuid())

  pollutantKey String
  pollutant    ConfigPollutant @relation(fields: [pollutantKey], references: [key], onDelete: Cascade)

  benchmarkType BenchmarkType
  waterType     WaterType     @default(ALL)

  value    Decimal  @db.Decimal(12, 6)
  valueMax Decimal? @db.Decimal(12, 6)
  unit     String   @db.VarChar(20)

  source         String  @db.VarChar(200)
  sourceDocument String? @db.Text
  sourceUrl      String? @db.Text

  hardnessDependent Boolean @default(false)
  hardnessEquation  String? @db.Text

  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  violationSamples ViolationSample[]

  @@unique([pollutantKey, benchmarkType, waterType])
  @@index([pollutantKey])
  @@index([benchmarkType])
  @@index([waterType])
  @@map("pollutant_benchmarks")
}

enum BenchmarkType {
  ANNUAL_NAL
  INSTANT_NAL
  MCL
  ACTION_LEVEL
  CMC
  CCC
  SECONDARY_MCL
  HEALTH_ADVISORY
}

enum WaterType {
  FRESHWATER
  SALTWATER
  DRINKING
  ALL
}

// =============================================================================
// eSMR (Electronic Self-Monitoring Report) Models
// =============================================================================

model ESMRRegion {
  code String @id @db.VarChar(10)
  name String @unique @db.VarChar(100)

  facilities ESMRFacility[]

  @@map("esmr_regions")
}

model ESMRFacility {
  facilityPlaceId Int        @id
  facilityName    String     @db.VarChar(200)
  regionCode      String     @db.VarChar(10)
  region          ESMRRegion @relation(fields: [regionCode], references: [code])

  receivingWaterBody String? @db.VarChar(200)

  createdAt  DateTime @default(now())
  lastSeenAt DateTime @default(now())

  locations        ESMRLocation[]
  linkedFacilities Facility[]

  @@index([regionCode])
  @@index([facilityName])
  @@index([receivingWaterBody])
  @@map("esmr_facilities")
}

model ESMRLocation {
  locationPlaceId Int          @id
  facilityPlaceId Int
  facility        ESMRFacility @relation(fields: [facilityPlaceId], references: [facilityPlaceId], onDelete: Cascade)

  locationCode String           @db.VarChar(50)
  locationType ESMRLocationType

  latitude     Decimal? @db.Decimal(9, 6)
  longitude    Decimal? @db.Decimal(9, 6)
  locationDesc String?  @db.Text

  createdAt  DateTime @default(now())
  lastSeenAt DateTime @default(now())

  samples ESMRSample[]

  @@index([facilityPlaceId])
  @@index([locationType])
  @@map("esmr_locations")
}

enum ESMRLocationType {
  EFFLUENT_MONITORING
  INFLUENT_MONITORING
  RECEIVING_WATER_MONITORING
  RECYCLED_WATER_MONITORING
  INTERNAL_MONITORING
  GROUNDWATER_MONITORING

  @@map("esmr_location_type")
}

model ESMRParameter {
  id            String  @id @default(cuid())
  parameterName String  @unique @db.VarChar(200)
  category      String? @db.VarChar(100)

  canonicalKey String?

  notes String? @db.Text

  samples ESMRSample[]

  @@index([category])
  @@map("esmr_parameters")
}

model ESMRAnalyticalMethod {
  methodCode String  @id @db.VarChar(50)
  methodName String  @db.VarChar(500)
  category   String? @db.VarChar(100)
  notes      String? @db.Text

  samples ESMRSample[]

  @@map("esmr_analytical_methods")
}

model ESMRSample {
  id String @id @default(cuid())

  locationPlaceId    Int
  location           ESMRLocation          @relation(fields: [locationPlaceId], references: [locationPlaceId], onDelete: Cascade)
  parameterId        String
  parameter          ESMRParameter         @relation(fields: [parameterId], references: [id])
  analyticalMethodId String?
  analyticalMethod   ESMRAnalyticalMethod? @relation(fields: [analyticalMethodId], references: [methodCode])

  samplingDate DateTime @db.Date
  samplingTime DateTime @db.Time
  analysisDate DateTime @db.Date
  analysisTime DateTime @db.Time

  qualifier        ESMRQualifier
  result           Decimal?      @db.Decimal(18, 6)
  units            String        @db.VarChar(50)
  calculatedMethod String?       @db.VarChar(100)

  mdl Decimal? @db.Decimal(18, 6)
  ml  Decimal? @db.Decimal(18, 6)
  rl  Decimal? @db.Decimal(18, 6)

  reviewPriorityIndicator Boolean?
  qaCodes                 String?  @db.VarChar(50)
  comments                String?  @db.Text

  reportName    String @db.VarChar(200)
  smrDocumentId Int

  createdAt DateTime @default(now())

  violationSamples ViolationSample[]

  @@unique([locationPlaceId, parameterId, samplingDate, samplingTime, smrDocumentId], name: "esmr_sample_unique")
  @@index([locationPlaceId, samplingDate])
  @@index([parameterId, samplingDate])
  @@index([samplingDate])
  @@index([smrDocumentId])
  @@index([qualifier])
  @@index([reviewPriorityIndicator])
  @@map("esmr_samples")
}

enum ESMRQualifier {
  DETECTED
  LESS_THAN
  GREATER_THAN
  NOT_DETECTED
  DETECTED_NOT_QUANTIFIED

  @@map("esmr_qualifier")
}

model ESMRImport {
  id String @id @default(cuid())

  importDate DateTime @default(now())
  sourceUrl  String   @db.Text
  sourceFile String   @db.VarChar(500)
  dataYear   Int

  recordsProcessed Int
  recordsInserted  Int
  recordsUpdated   Int
  recordsErrored   Int
  errors           String? @db.Text

  startedAt   DateTime
  completedAt DateTime?

  notes String? @db.Text

  @@index([importDate])
  @@index([dataYear])
  @@map("esmr_imports")
}

model ESMRImportError {
  id String @id @default(cuid())

  importId     String
  rowNumber    Int
  rawData      String   @db.Text
  errorMessage String   @db.Text
  createdAt    DateTime @default(now())

  @@index([importId])
  @@map("esmr_import_errors")
}
